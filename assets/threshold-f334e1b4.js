import{H,j as s,u as E,b as P,r as f,a as Q,s as W,G as v,K as $,Q as Y,S as q,T as K,B as z,al as X,c as Z,am as g,a2 as O}from"./index-e25e605d.js";import{M as ss}from"./main-41d42279.js";const es=({field:a,index:u,register:y,setSelected:p,setSelectNumber:h})=>{var S;const t=(S=H())==null?void 0:S.color,n=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function e(r){const C=r.target.value.replace(/[^\d]/g,"");r.target.value=C,parseInt(C)>100?r.target.value="100":parseInt(C)<0&&(r.target.value="0"),h(parseInt(r.target.value)|0)}const i={width:"3em",borderStyle:"solid",backgroundColor:t==null?void 0:t.white,color:t==null?void 0:t.black,border:`1px solid ${t==null?void 0:t.black}`};function x(r){r.target.value===""&&(r.target.value="0"),p(""),h(0)}return s.jsxs(s.Fragment,{children:[s.jsxs("tr",{children:[s.jsx("td",{rowSpan:2,children:u+1}),s.jsx("td",{rowSpan:2,children:a.EmpName}),s.jsx("td",{children:"ATU & 既有客戶"}),n.map(r=>s.jsxs("td",{style:{whiteSpace:"nowrap"},children:[s.jsx("input",{type:"text",...y(`threshold.${u}.${r}.existCus`,{setValueAs:o=>o?parseInt(o):0}),placeholder:"...",autoComplete:"off",style:i,onChangeCapture:e,onFocusCapture:o=>{o.target.value="",p(o.target.name)},onBlurCapture:x}),s.jsx("span",{style:{marginLeft:".2em"},children:"%"})]},r))]}),s.jsxs("tr",{children:[s.jsx("td",{children:"新客戶"}),n.map(r=>s.jsxs("td",{style:{whiteSpace:"nowrap"},children:[s.jsx("input",{type:"text",...y(`threshold.${u}.${r}.newCus`,{setValueAs:o=>o?parseInt(o):0}),placeholder:"...",autoComplete:"off",style:i,onChangeCapture:e,onFocusCapture:o=>{o.target.value="",p(o.target.name)},onBlurCapture:x,tabIndex:-1}),s.jsx("span",{style:{marginLeft:".2em"},children:"%"})]},r))]})]})};function A(){const a=E(t=>t.salesList),u=E(t=>t.threshold),y=a.body.map(t=>{function n(i){return{existCus:100-parseInt(i)|0,newCus:parseInt(i)|0}}const e=u.body.find(i=>i.EmpName===(t==null?void 0:t.EmpName));return{EmpName:t==null?void 0:t.EmpName,EmpId:t==null?void 0:t.EmpId,Jan:n(e==null?void 0:e.Jan),Feb:n(e==null?void 0:e.Feb),Mar:n(e==null?void 0:e.Mar),Apr:n(e==null?void 0:e.Apr),May:n(e==null?void 0:e.May),Jun:n(e==null?void 0:e.Jun),Jul:n(e==null?void 0:e.Jul),Aug:n(e==null?void 0:e.Aug),Sep:n(e==null?void 0:e.Sep),Oct:n(e==null?void 0:e.Oct),Nov:n(e==null?void 0:e.Nov),Dec:n(e==null?void 0:e.Dec)}}),p=a.body.map(t=>u.body.some(n=>n.Empid===(t==null?void 0:t.EmpId))),h=u.status;return{dataSet:y,status:h,dataExist:p}}const ts=()=>{const{t:a}=P(["common"]),u=E(l=>l.time),p=E(l=>l.nowUser).body.EmpId,[h,t]=f.useState(""),[n,e]=f.useState(0),i=f.useRef(!1),x=A().dataSet,S=A().status,r=A().dataExist,o=Q();f.useEffect(()=>{o(W(u.thisYear))},[o,u]);const C=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],T=x,d=v({existCus:$().min(0,"最小0").max(100,"最大100"),newCus:$().min(0,"最小0").max(100,"最大100")}),b=v({Jan:d,Feb:d,Mar:d,Apr:d,May:d,Jun:d,Jul:d,Aug:d,Sep:d,Oct:d,Nov:d,Dec:d}),U=v({threshold:Y().of(b)}),{register:k,handleSubmit:B,formState:{errors:I},control:L,setValue:J}=q({shouldUnregister:!0,criteriaMode:"all",mode:"onChange",resolver:K(U),defaultValues:{threshold:T}}),{fields:_,replace:F}=z({name:"threshold",control:L});Object.keys(I).length!==0&&console.log(I),f.useEffect(()=>{i.current||S==="succeeded"&&(F(x),i.current=!0)},[S,F,x]),f.useEffect(()=>{let l;h.endsWith("existCus")?l="newCus":h.endsWith("newCus")&&(l="existCus");const m=h.split("."),j=parseInt(m[1]),w=m[2];J(`threshold.${j}.${w}.${l}`,100-n)},[h,J,n]);async function V(l,m,j){const w=await r;return O.threshold.post(u.thisYear,m,j,w[l],p)}async function R(l){const m=l.threshold;(await Promise.all(m.map(async(c,G)=>{var M;const N={};for(const D of C)N[D]=(M=c==null?void 0:c[D])==null?void 0:M.newCus;return{name:c.EmpName,status:await V(G,c.EmpId,N)}}))).map(c=>c.status).every(c=>c==="設定新增完成")?g.success("設定成功"):g.error("設定失敗")}return s.jsx(ss,{children:s.jsxs(s.Fragment,{children:[s.jsx(X,{text:a("buttons.save")}),s.jsx(Z,{title:"客戶拜訪佔比警示值",children:s.jsx(s.Fragment,{children:s.jsx("form",{id:"threshold",onSubmit:B(R),children:s.jsxs("table",{children:[s.jsx("thead",{children:s.jsxs("tr",{children:[s.jsx("td",{children:"NO."}),s.jsx("td",{children:"業務"}),s.jsx("td",{children:"類別"}),s.jsx("td",{children:a("month.1")}),s.jsx("td",{children:a("month.2")}),s.jsx("td",{children:a("month.3")}),s.jsx("td",{children:a("month.4")}),s.jsx("td",{children:a("month.5")}),s.jsx("td",{children:a("month.6")}),s.jsx("td",{children:a("month.7")}),s.jsx("td",{children:a("month.8")}),s.jsx("td",{children:a("month.9")}),s.jsx("td",{children:a("month.10")}),s.jsx("td",{children:a("month.11")}),s.jsx("td",{children:a("month.12")})]})}),s.jsx("tbody",{children:_.map((l,m)=>s.jsx(es,{field:l,index:m,register:k,setSelected:t,setSelectNumber:e},l.id))})]})})})})]})})},rs=()=>s.jsx(s.Fragment,{children:s.jsx(ts,{})});export{rs as default};
