import{H as R,j as s,u as E,b as H,r as y,a as P,s as W,Q as M,A as Y}from"./index-d92dbf70.js";import{M as q,s as G}from"./main-6b5da64a.js";import{c as A,b as D,e as Q,o as z}from"./index.esm-80f0e74e.js";import{c as K,b as X,s as Z}from"./index.esm-a483082b.js";const O=({field:n,index:i,register:a,setSelected:p,setSelectNumber:h})=>{var C;const u=(C=R())==null?void 0:C.color,t=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function e(r){const S=r.target.value.replace(/[^\d]/g,"");r.target.value=S,parseInt(S)>100?r.target.value="100":parseInt(S)<0&&(r.target.value="0"),h(parseInt(r.target.value)|0)}const x={width:"3em",borderStyle:"solid",backgroundColor:u==null?void 0:u.white,color:u==null?void 0:u.black,border:`1px solid ${u==null?void 0:u.black}`};function f(r){r.target.value===""&&(r.target.value="0"),p(""),h(0)}return s.jsxs(s.Fragment,{children:[s.jsxs("tr",{children:[s.jsx("td",{rowSpan:2,children:i+1}),s.jsx("td",{rowSpan:2,children:n.EmpName}),s.jsx("td",{children:"ATU & 既有客戶"}),t.map(r=>s.jsxs("td",{style:{whiteSpace:"nowrap"},children:[s.jsx("input",{type:"text",...a(`threshold.${i}.${r}.existCus`,{setValueAs:o=>o?parseInt(o):0}),placeholder:"...",autoComplete:"off",style:x,onChangeCapture:e,onFocusCapture:o=>{o.target.value="",p(o.target.name)},onBlurCapture:f}),s.jsx("span",{style:{marginLeft:".2em"},children:"%"})]},r))]}),s.jsxs("tr",{children:[s.jsx("td",{children:"新客戶"}),t.map(r=>s.jsxs("td",{style:{whiteSpace:"nowrap"},children:[s.jsx("input",{type:"text",...a(`threshold.${i}.${r}.newCus`,{setValueAs:o=>o?parseInt(o):0}),placeholder:"...",autoComplete:"off",style:x,onChangeCapture:e,onFocusCapture:o=>{o.target.value="",p(o.target.name)},onBlurCapture:f,tabIndex:-1}),s.jsx("span",{style:{marginLeft:".2em"},children:"%"})]},r))]})]})};function ss(){const n=E(t=>t.salesList),i=E(t=>t.threshold);function a(t){return{existCus:100-parseInt(t)|0,newCus:parseInt(t)|0}}const p=n.body.map(t=>{const e=i.body.find(x=>x.EmpName===(t==null?void 0:t.EmpName));return{EmpName:t==null?void 0:t.EmpName,EmpId:t==null?void 0:t.EmpId,Jan:a(e==null?void 0:e.Jan),Feb:a(e==null?void 0:e.Feb),Mar:a(e==null?void 0:e.Mar),Apr:a(e==null?void 0:e.Apr),May:a(e==null?void 0:e.May),Jun:a(e==null?void 0:e.Jun),Jul:a(e==null?void 0:e.Jul),Aug:a(e==null?void 0:e.Aug),Sep:a(e==null?void 0:e.Sep),Oct:a(e==null?void 0:e.Oct),Nov:a(e==null?void 0:e.Nov),Dec:a(e==null?void 0:e.Dec)}}),h=n.body.map(t=>i.body.some(e=>e.Empid===(t==null?void 0:t.EmpId))),u=i.status;return{dataSet:p,status:u,dataExist:h}}const es=()=>{const{t:n}=H(["common"]),i=E(l=>l.time),p=E(l=>l.nowUser).body.EmpId,[h,u]=y.useState(""),[t,e]=y.useState(0),x=y.useRef(!1),{dataSet:f,status:C,dataExist:r}=ss(),o=P();y.useEffect(()=>{o(W(i.thisYear))},[o,i]);const S=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],$=f,d=A().shape({existCus:D().min(0,"最小0").max(100,"最大100"),newCus:D().min(0,"最小0").max(100,"最大100")}),T=A().shape({Jan:d,Feb:d,Mar:d,Apr:d,May:d,Jun:d,Jul:d,Aug:d,Sep:d,Oct:d,Nov:d,Dec:d}),b=A({threshold:Q().of(T)}),{register:g,handleSubmit:U,control:L,setValue:v}=K({shouldUnregister:!0,criteriaMode:"all",mode:"onChange",resolver:z(b),defaultValues:{threshold:$}}),{fields:_,replace:I}=X({name:"threshold",control:L});y.useEffect(()=>{x.current||C==="succeeded"&&(I(f),x.current=!0)},[C,I,f]),y.useEffect(()=>{let l="newCus";h.endsWith("existCus")?l="newCus":h.endsWith("newCus")&&(l="existCus");const m=h.split("."),j=parseInt(m[1]),w=m[2];v(`threshold.${j}.${w}.${l}`,100-t)},[h,v,t]);async function k(l,m,j){const w=r;return Y.threshold.post(i.thisYear,m,j,w[l],p)}async function B(l){const m=l.threshold;(await Promise.all(m.map(async(c,V)=>{var F;const J={};for(const N of S)J[N]=(F=c==null?void 0:c[N])==null?void 0:F.newCus;return{name:c.EmpName,status:await k(V,c.EmpId,J)}}))).map(c=>c.status).every(c=>c==="設定新增完成")?M.success("設定成功"):M.error("設定失敗")}return s.jsx(q,{children:s.jsxs(s.Fragment,{children:[s.jsx(Z,{text:n("buttons.save")}),s.jsx(G,{title:"客戶拜訪佔比警示值",children:s.jsx(s.Fragment,{children:s.jsx("form",{id:"threshold",onSubmit:U(B),children:s.jsxs("table",{children:[s.jsx("thead",{children:s.jsxs("tr",{children:[s.jsx("td",{children:"NO."}),s.jsx("td",{children:"業務"}),s.jsx("td",{children:"類別"}),s.jsx("td",{children:n("month.1")}),s.jsx("td",{children:n("month.2")}),s.jsx("td",{children:n("month.3")}),s.jsx("td",{children:n("month.4")}),s.jsx("td",{children:n("month.5")}),s.jsx("td",{children:n("month.6")}),s.jsx("td",{children:n("month.7")}),s.jsx("td",{children:n("month.8")}),s.jsx("td",{children:n("month.9")}),s.jsx("td",{children:n("month.10")}),s.jsx("td",{children:n("month.11")}),s.jsx("td",{children:n("month.12")})]})}),s.jsx("tbody",{children:_.map((l,m)=>s.jsx(O,{field:l,index:m,register:g,setSelected:u,setSelectNumber:e},l.id))})]})})})})]})})},os=()=>s.jsx(s.Fragment,{children:s.jsx(es,{})});export{os as default};
